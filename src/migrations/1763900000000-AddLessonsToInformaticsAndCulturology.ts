import { MigrationInterface, QueryRunner } from 'typeorm';

/**
 * Миграция для добавления уроков к дисциплинам:
 * - Информатика и ИКТ (метатег: Компьютерные науки и ИИ)
 * - Культурология (метатег: Искусство)
 * 
 * Для каждой темы создается от 4 до 10 уроков с конкретными названиями.
 */

export class AddLessonsToInformaticsAndCulturology1763900000000
  implements MigrationInterface
{
  name = 'AddLessonsToInformaticsAndCulturology1763900000000';

  /**
   * Экранирует строку для SQL
   */
  private escapeString(str: string): string {
    return `'${str.replace(/'/g, "''")}'`;
  }

  /**
   * Генерирует уроки для темы
   */
  private generateLessonsForTopic(
    topicId: string,
    topicName: string,
    lessonCount: number,
    lessonNames: string[],
    startLessonId: number,
  ): Array<{
    LessonID: string;
    ID: number;
    LessonName: string;
    TopicID: string;
    IsVerified: boolean;
    Order: number;
    Description: string | null;
    CreatedAt: Date;
    UpdatedAt: Date;
  }> {
    const lessons: Array<{
      LessonID: string;
      ID: number;
      LessonName: string;
      TopicID: string;
      IsVerified: boolean;
      Order: number;
      Description: string | null;
      CreatedAt: Date;
      UpdatedAt: Date;
    }> = [];
    const baseDate = new Date('2025-08-16T12:00:00Z');

    for (let i = 0; i < lessonCount; i++) {
      const tempId = `temp-${topicId}-${startLessonId + i}`;
      lessons.push({
        LessonID: tempId,
        ID: startLessonId + i,
        LessonName: lessonNames[i] || `Урок ${i + 1}: ${topicName}`,
        TopicID: topicId,
        IsVerified: false,
        Order: i + 1,
        Description: null,
        CreatedAt: baseDate,
        UpdatedAt: baseDate,
      });
    }

    return lessons;
  }

  /**
   * Получает план уроков для темы на основе её названия
   * Названия уроков сделаны конкретными, не абстрактными
   */
  private getLessonPlanForTopic(topicName: string): {
    count: number;
    names: string[];
  } {
    const lowerTopicName = topicName.toLowerCase();

    // === ИНФОРМАТИКА И ИКТ ===

    // Информатика как наука
    if (lowerTopicName.includes('информатика как наука') || lowerTopicName.includes('информация и её представление')) {
      return {
        count: 6,
        names: [
          'Что такое информатика: наука об информации',
          'Информация: определение и свойства',
          'Виды информации: текстовая, числовая, графическая, звуковая',
          'Представление информации в компьютере',
          'Единицы измерения информации: бит, байт, килобайт',
          'Практика: работа с информацией разных типов',
        ],
      };
    }

    // Системы счисления
    if (lowerTopicName.includes('системы счисления') || lowerTopicName.includes('кодирование информации')) {
      return {
        count: 7,
        names: [
          'Десятичная система счисления: как мы считаем',
          'Двоичная система: основа работы компьютера',
          'Восьмеричная и шестнадцатеричная системы',
          'Перевод чисел между системами счисления',
          'Кодирование текста: ASCII и Unicode',
          'Кодирование изображений: пиксели и цвета',
          'Практика: перевод чисел и кодирование данных',
        ],
      };
    }

    // Архитектура компьютера
    if (lowerTopicName.includes('архитектура компьютера') || lowerTopicName.includes('процессор, память')) {
      return {
        count: 7,
        names: [
          'Процессор: мозг компьютера',
          'Память: оперативная и постоянная',
          'Жёсткий диск и SSD: хранение данных',
          'Периферийные устройства: клавиатура, мышь, монитор',
          'Материнская плата: связь компонентов',
          'Практика: сборка виртуального компьютера',
          'Выбор комплектующих для задач',
        ],
      };
    }

    // Операционные системы
    if (lowerTopicName.includes('операционные системы') || lowerTopicName.includes('файловые системы')) {
      return {
        count: 6,
        names: [
          'Что такое операционная система',
          'Windows, Linux, macOS: сравнение систем',
          'Файловая система: папки и файлы',
          'Работа с файлами: создание, копирование, удаление',
          'Практика: навигация по файловой системе',
          'Настройка операционной системы',
        ],
      };
    }

    // Компьютерные сети
    if (lowerTopicName.includes('компьютерные сети') || lowerTopicName.includes('интернет') || lowerTopicName.includes('протоколы')) {
      return {
        count: 8,
        names: [
          'Что такое компьютерная сеть',
          'Локальные и глобальные сети',
          'Модель OSI: как работает сеть',
          'Протоколы: TCP/IP, HTTP, HTTPS',
          'DNS: как браузер находит сайты',
          'Интернет: всемирная паутина',
          'Практика: настройка сетевого подключения',
          'Безопасность в сети',
        ],
      };
    }

    // Информационная безопасность
    if (lowerTopicName.includes('информационная безопасность') || lowerTopicName.includes('кибергигиена')) {
      return {
        count: 7,
        names: [
          'Угрозы в интернете: вирусы и хакеры',
          'Пароли: как создать надёжный пароль',
          'Двухфакторная аутентификация',
          'Фишинг: как не попасться на удочку',
          'Защита личных данных в интернете',
          'Антивирусы и файрволы',
          'Практика: проверка безопасности аккаунтов',
        ],
      };
    }

    // Алгоритмы
    if (lowerTopicName.includes('алгоритмы') || lowerTopicName.includes('алгоритмическое мышление')) {
      return {
        count: 7,
        names: [
          'Что такое алгоритм: пошаговая инструкция',
          'Исполнители алгоритмов: человек и компьютер',
          'Способы записи алгоритмов: блок-схемы',
          'Линейные алгоритмы: последовательность действий',
          'Ветвление: выбор пути выполнения',
          'Циклы: повторение действий',
          'Практика: составление алгоритмов для задач',
        ],
      };
    }

    // Структуры данных
    if (lowerTopicName.includes('структуры данных') || lowerTopicName.includes('массив, список')) {
      return {
        count: 7,
        names: [
          'Массив: хранение однотипных данных',
          'Список: динамическая структура',
          'Стек: последний пришёл — первый ушёл',
          'Очередь: первый пришёл — первый ушёл',
          'Когда использовать каждую структуру',
          'Практика: работа со структурами данных',
          'Решение задач с использованием структур',
        ],
      };
    }

    // Сложность алгоритмов
    if (lowerTopicName.includes('сложность алгоритмов')) {
      return {
        count: 5,
        names: [
          'Зачем оценивать сложность алгоритмов',
          'Время выполнения: быстрые и медленные алгоритмы',
          'O-нотация: как записывать сложность',
          'Примеры: линейная, квадратичная, логарифмическая сложность',
          'Практика: оценка сложности алгоритмов',
        ],
      };
    }

    // Программирование: основы
    if (lowerTopicName.includes('программирование: переменные') || lowerTopicName.includes('типы, ветвления, циклы')) {
      return {
        count: 8,
        names: [
          'Переменные: хранение данных в программе',
          'Типы данных: числа, строки, логические значения',
          'Ветвление: if-else для принятия решений',
          'Циклы for: повторение с счётчиком',
          'Циклы while: повторение по условию',
          'Практика: написание простых программ',
          'Отладка: поиск и исправление ошибок',
          'Создание собственной программы',
        ],
      };
    }

    // Функции и модули
    if (lowerTopicName.includes('функции и модули') || lowerTopicName.includes('рекурсия')) {
      return {
        count: 7,
        names: [
          'Функции: переиспользование кода',
          'Параметры и возвращаемые значения',
          'Модули: организация кода в файлы',
          'Импорт и экспорт функций',
          'Рекурсия: функция вызывает сама себя',
          'Практика: создание библиотеки функций',
          'Решение задач с помощью рекурсии',
        ],
      };
    }

    // ООП
    if (lowerTopicName.includes('объектно-ориентированное программирование')) {
      return {
        count: 7,
        names: [
          'Классы и объекты: моделирование реального мира',
          'Атрибуты: свойства объекта',
          'Методы: действия объекта',
          'Наследование: создание новых классов',
          'Инкапсуляция: скрытие деталей реализации',
          'Практика: создание классов и объектов',
          'Проект: объектно-ориентированная программа',
        ],
      };
    }

    // Работа с файлами
    if (lowerTopicName.includes('работа с файлами') || lowerTopicName.includes('вводом-выводом')) {
      return {
        count: 6,
        names: [
          'Чтение файлов: получение данных',
          'Запись в файлы: сохранение данных',
          'Форматы файлов: текстовые и бинарные',
          'Обработка ошибок при работе с файлами',
          'Практика: создание программы для работы с файлами',
          'Обработка CSV и JSON файлов',
        ],
      };
    }

    // Отладка и тестирование
    if (lowerTopicName.includes('отладка') || lowerTopicName.includes('тестирование') || lowerTopicName.includes('качество кода')) {
      return {
        count: 6,
        names: [
          'Отладка: поиск ошибок в коде',
          'Инструменты отладки: пошаговое выполнение',
          'Тестирование: проверка правильности работы',
          'Unit-тесты: проверка отдельных функций',
          'Чистый код: читаемость и стиль',
          'Практика: отладка и тестирование программы',
        ],
      };
    }

    // Git и контроль версий
    if (lowerTopicName.includes('контроль версий') || lowerTopicName.includes('git')) {
      return {
        count: 7,
        names: [
          'Зачем нужен контроль версий',
          'Git: система управления версиями',
          'Основные команды: init, add, commit',
          'Ветки: параллельная разработка',
          'Слияние веток: объединение изменений',
          'Работа в команде: push и pull',
          'Практика: создание репозитория и работа с Git',
        ],
      };
    }

    // Базы данных
    if (lowerTopicName.includes('базы данных') || lowerTopicName.includes('sql')) {
      return {
        count: 7,
        names: [
          'Что такое база данных',
          'Реляционные базы: таблицы и связи',
          'SQL: язык запросов к базе данных',
          'SELECT: выборка данных',
          'INSERT, UPDATE, DELETE: изменение данных',
          'Практика: создание базы данных и запросы',
          'Проектирование структуры базы данных',
        ],
      };
    }

    // Проектирование данных
    if (lowerTopicName.includes('проектирование данных') || lowerTopicName.includes('нормализация')) {
      return {
        count: 6,
        names: [
          'Таблицы: структура данных',
          'Связи между таблицами: один-к-одному, один-ко-многим',
          'Первичные и внешние ключи',
          'Нормализация: устранение дублирования',
          'Практика: проектирование базы данных',
          'Оптимизация структуры базы',
        ],
      };
    }

    // Веб-разработка
    if (lowerTopicName.includes('веб-разработка') || lowerTopicName.includes('html') || lowerTopicName.includes('css')) {
      return {
        count: 8,
        names: [
          'HTML: структура веб-страницы',
          'Теги: заголовки, параграфы, списки',
          'CSS: оформление страницы',
          'Селекторы: выбор элементов для стилизации',
          'Цвета, шрифты, отступы',
          'Адаптивный дизайн: для разных устройств',
          'Практика: создание веб-страницы',
          'Доступность: веб для всех',
        ],
      };
    }

    // Клиент-сервер и API
    if (lowerTopicName.includes('клиент—сервер') || lowerTopicName.includes('api') || lowerTopicName.includes('rest')) {
      return {
        count: 7,
        names: [
          'Клиент и сервер: как работает интернет',
          'HTTP: протокол передачи данных',
          'Запросы и ответы: GET, POST, PUT, DELETE',
          'API: интерфейс для взаимодействия',
          'REST: архитектурный стиль',
          'JSON: формат обмена данными',
          'Практика: создание простого API',
        ],
      };
    }

    // Скрипты и автоматизация
    if (lowerTopicName.includes('скрипты') || lowerTopicName.includes('автоматизация')) {
      return {
        count: 6,
        names: [
          'Скрипты: автоматизация рутинных задач',
          'Примеры: обработка файлов, отправка писем',
          'Планировщик задач: запуск по расписанию',
          'Практика: написание скрипта для автоматизации',
          'Обработка ошибок в скриптах',
          'Создание полезных утилит',
        ],
      };
    }

    // Электронные таблицы
    if (lowerTopicName.includes('электронные таблицы') || lowerTopicName.includes('визуализация данных')) {
      return {
        count: 6,
        names: [
          'Электронные таблицы: Excel и Google Sheets',
          'Формулы: вычисления в таблицах',
          'Функции: SUM, AVERAGE, IF',
          'Графики и диаграммы: визуализация данных',
          'Практика: создание таблицы с вычислениями',
          'Анализ данных в таблицах',
        ],
      };
    }

    // Анализ данных
    if (lowerTopicName.includes('анализ данных') || lowerTopicName.includes('статистика')) {
      return {
        count: 7,
        names: [
          'Описательная статистика: среднее, медиана, мода',
          'Графики: гистограммы, диаграммы рассеяния',
          'Распределение данных: нормальное и другие',
          'Корреляция: связь между переменными',
          'Практика: анализ набора данных',
          'Интерпретация результатов',
          'Создание отчёта с выводами',
        ],
      };
    }

    // Искусственный интеллект
    if (lowerTopicName.includes('искусственный интеллект') || lowerTopicName.includes('машинное обучение')) {
      return {
        count: 8,
        names: [
          'Что такое искусственный интеллект',
          'Машинное обучение: обучение на данных',
          'Нейронные сети: имитация мозга',
          'Обучение с учителем: классификация и регрессия',
          'Обучение без учителя: кластеризация',
          'Примеры применения ИИ в жизни',
          'Практика: создание простой модели',
          'Этика искусственного интеллекта',
        ],
      };
    }

    // Генеративный ИИ
    if (lowerTopicName.includes('генеративный ии') || lowerTopicName.includes('этика использования')) {
      return {
        count: 6,
        names: [
          'Генеративный ИИ: создание контента',
          'ChatGPT и другие языковые модели',
          'Генерация изображений: DALL-E, Midjourney',
          'Практики использования: помощь в работе',
          'Этика: авторство и ответственность',
          'Практика: работа с генеративным ИИ',
        ],
      };
    }

    // Численные методы
    if (lowerTopicName.includes('численные методы') || lowerTopicName.includes('вычислительные эксперименты')) {
      return {
        count: 6,
        names: [
          'Численные методы: решение задач на компьютере',
          'Приближённые вычисления',
          'Методы решения уравнений',
          'Интегрирование и дифференцирование',
          'Практика: решение задач численными методами',
          'Визуализация результатов вычислений',
        ],
      };
    }

    // Робототехника
    if (lowerTopicName.includes('робототехника') || lowerTopicName.includes('сенсоры')) {
      return {
        count: 6,
        names: [
          'Роботы: механизмы и управление',
          'Сенсоры: как робот воспринимает мир',
          'Актуаторы: как робот действует',
          'Программирование роботов',
          'Симуляторы: виртуальные роботы',
          'Практика: создание программы для робота',
        ],
      };
    }

    // UX и HCI
    if (lowerTopicName.includes('человеко-компьютерное взаимодействие') || lowerTopicName.includes('ux')) {
      return {
        count: 6,
        names: [
          'UX: пользовательский опыт',
          'Интерфейс: как пользователь взаимодействует с программой',
          'Удобство использования: простота и понятность',
          'Прототипирование: создание макетов',
          'Тестирование интерфейса',
          'Практика: проектирование интерфейса',
        ],
      };
    }

    // Цифровая этика
    if (lowerTopicName.includes('цифровая этика') || lowerTopicName.includes('персональные данные') || lowerTopicName.includes('авторское право')) {
      return {
        count: 6,
        names: [
          'Персональные данные: что это и как защищать',
          'GDPR и защита данных в Европе',
          'Авторское право: использование чужих материалов',
          'Лицензии: открытый код и коммерческий',
          'Этика в программировании',
          'Практика: анализ этических дилемм',
        ],
      };
    }

    // Цифровые проекты
    if (lowerTopicName.includes('цифровые проекты') || lowerTopicName.includes('agile') || lowerTopicName.includes('канбан')) {
      return {
        count: 7,
        names: [
          'Постановка задач: что нужно сделать',
          'Agile: гибкая методология разработки',
          'Канбан: визуализация работы',
          'Командная работа: роли в команде',
          'Планирование спринта',
          'Практика: организация проекта',
          'Презентация проекта',
        ],
      };
    }

    // Облачные вычисления
    if (lowerTopicName.includes('облачные вычисления') || lowerTopicName.includes('iaas') || lowerTopicName.includes('paas')) {
      return {
        count: 6,
        names: [
          'Облачные вычисления: что это такое',
          'IaaS: инфраструктура как услуга',
          'PaaS: платформа как услуга',
          'SaaS: программное обеспечение как услуга',
          'Примеры облачных сервисов',
          'Практика: работа с облачными сервисами',
        ],
      };
    }

    // Мобильная разработка
    if (lowerTopicName.includes('мобильная разработка')) {
      return {
        count: 6,
        names: [
          'Платформы: iOS и Android',
          'Инструменты разработки: Xcode, Android Studio',
          'Особенности мобильных приложений',
          'UI/UX для мобильных устройств',
          'Практика: создание простого мобильного приложения',
          'Публикация приложения в магазине',
        ],
      };
    }

    // Компьютерная графика
    if (lowerTopicName.includes('компьютерная графика') || lowerTopicName.includes('игровые движки')) {
      return {
        count: 6,
        names: [
          'Компьютерная графика: 2D и 3D',
          'Растровая и векторная графика',
          'Игровые движки: Unity, Unreal Engine',
          '3D-моделирование: создание объектов',
          'Анимация: движение в играх',
          'Практика: создание простой игры',
        ],
      };
    }

    // Обработка мультимедиа
    if (lowerTopicName.includes('обработка мультимедиа') || lowerTopicName.includes('изображение, звук, видео')) {
      return {
        count: 6,
        names: [
          'Обработка изображений: фильтры и эффекты',
          'Обработка звука: редактирование аудио',
          'Обработка видео: монтаж и эффекты',
          'Форматы файлов: JPEG, PNG, MP3, MP4',
          'Практика: создание мультимедийного проекта',
          'Оптимизация файлов для веба',
        ],
      };
    }

    // IoT
    if (lowerTopicName.includes('интернет вещей') || lowerTopicName.includes('iot')) {
      return {
        count: 6,
        names: [
          'Интернет вещей: умные устройства',
          'Устройства IoT: датчики и контроллеры',
          'Протоколы связи: Wi-Fi, Bluetooth, Zigbee',
          'Примеры применения: умный дом, промышленность',
          'Практика: подключение IoT-устройства',
          'Безопасность IoT-устройств',
        ],
      };
    }

    // Квантовые вычисления
    if (lowerTopicName.includes('квантовые вычисления')) {
      return {
        count: 5,
        names: [
          'Квантовые вычисления: принципы работы',
          'Кубиты: квантовые биты',
          'Квантовые алгоритмы: преимущества',
          'Применение: криптография и моделирование',
          'Будущее квантовых компьютеров',
        ],
      };
    }

    // Карьера в ИТ
    if (lowerTopicName.includes('карьера в ит') || lowerTopicName.includes('роли, практики') || lowerTopicName.includes('портфолио')) {
      return {
        count: 6,
        names: [
          'Роли в ИТ: разработчик, тестировщик, аналитик',
          'Практики работы: код-ревью, парное программирование',
          'Портфолио: демонстрация навыков',
          'Резюме для ИТ-специалиста',
          'Подготовка к собеседованию',
          'Практика: создание портфолио',
        ],
      };
    }

    // === КУЛЬТУРОЛОГИЯ ===

    // Предмет культурологии
    if (lowerTopicName.includes('предмет, объект и методы культурологии')) {
      return {
        count: 6,
        names: [
          'Что изучает культурология',
          'Объект культурологии: культура как явление',
          'Методы исследования культуры',
          'Культурология и другие науки',
          'Практика: анализ культурных явлений',
          'Структура культурологического знания',
        ],
      };
    }

    // Понятие культуры
    if (lowerTopicName.includes('понятие культуры') || lowerTopicName.includes('основные подходы')) {
      return {
        count: 7,
        names: [
          'Определение культуры: многообразие подходов',
          'Антропологический подход: культура как образ жизни',
          'Социологический подход: культура и общество',
          'Философский подход: культура и ценности',
          'Сравнение различных определений',
          'Практика: анализ понятия культуры',
          'Современное понимание культуры',
        ],
      };
    }

    // Структура культуры
    if (lowerTopicName.includes('структура культуры') || lowerTopicName.includes('материальная, духовная')) {
      return {
        count: 6,
        names: [
          'Материальная культура: вещи и предметы',
          'Духовная культура: идеи и ценности',
          'Символическая культура: знаки и смыслы',
          'Взаимосвязь уровней культуры',
          'Практика: анализ структуры конкретной культуры',
          'Современная структура культуры',
        ],
      };
    }

    // Культура и природа
    if (lowerTopicName.includes('культура и природа') || lowerTopicName.includes('культура и цивилизация')) {
      return {
        count: 6,
        names: [
          'Культура и природа: преобразование окружающего мира',
          'Экологическая культура: гармония с природой',
          'Культура и цивилизация: сходство и различия',
          'Техногенная цивилизация: культура и технологии',
          'Практика: сравнение культуры и цивилизации',
          'Современные вызовы: культура в эпоху экологического кризиса',
        ],
      };
    }

    // Функции культуры
    if (lowerTopicName.includes('функции культуры')) {
      return {
        count: 6,
        names: [
          'Адаптивная функция: приспособление к среде',
          'Коммуникативная функция: общение и передача информации',
          'Интегративная функция: объединение людей',
          'Регулятивная функция: нормы и правила',
          'Практика: анализ функций культуры в обществе',
          'Современные функции культуры',
        ],
      };
    }

    // История культурологической мысли
    if (lowerTopicName.includes('история культурологической мысли') || lowerTopicName.includes('от античности до постмодерна')) {
      return {
        count: 8,
        names: [
          'Античность: первые размышления о культуре',
          'Средневековье: культура и религия',
          'Эпоха Просвещения: культура и разум',
          'XIX век: становление культурологии как науки',
          'XX век: новые подходы к изучению культуры',
          'Постмодерн: критика традиционных концепций',
          'Практика: анализ эволюции взглядов на культуру',
          'Современные направления культурологии',
        ],
      };
    }

    // Культурологические школы
    if (lowerTopicName.includes('культурологические школы') || lowerTopicName.includes('эволюционизм, структурализм')) {
      return {
        count: 8,
        names: [
          'Эволюционизм: развитие культуры',
          'Культурно-историческая школа: уникальность культур',
          'Структурализм: структура и система',
          'Символическая антропология: символы и значения',
          'Функционализм: функции культуры',
          'Сравнение школ: сильные и слабые стороны',
          'Практика: применение подходов разных школ',
          'Современные синтетические подходы',
        ],
      };
    }

    // Социокультурная динамика
    if (lowerTopicName.includes('социокультурная динамика') || lowerTopicName.includes('культурные изменения')) {
      return {
        count: 6,
        names: [
          'Динамика культуры: как меняется культура',
          'Факторы культурных изменений',
          'Культурная диффузия: распространение элементов',
          'Культурная инновация: новые явления',
          'Практика: анализ культурных изменений',
          'Современные тенденции развития культуры',
        ],
      };
    }

    // Социализация
    if (lowerTopicName.includes('социализация') || lowerTopicName.includes('инкультурация') || lowerTopicName.includes('аккультурация')) {
      return {
        count: 6,
        names: [
          'Социализация: вхождение в общество',
          'Инкультурация: освоение своей культуры',
          'Аккультурация: освоение чужой культуры',
          'Агенты социализации: семья, школа, СМИ',
          'Практика: анализ процесса социализации',
          'Культурный шок и адаптация',
        ],
      };
    }

    // Личность и культура
    if (lowerTopicName.includes('личность и культура') || lowerTopicName.includes('культурная идентичность')) {
      return {
        count: 7,
        names: [
          'Личность как носитель культуры',
          'Культурная идентичность: кто я в культуре',
          'Кризисы идентичности: поиск себя',
          'Множественная идентичность: принадлежность к разным группам',
          'Практика: анализ собственной культурной идентичности',
          'Идентичность в современном мире',
          'Культура и самореализация личности',
        ],
      };
    }

    // Ценности и нормы
    if (lowerTopicName.includes('ценности, нормы') || lowerTopicName.includes('традиции, обряды')) {
      return {
        count: 7,
        names: [
          'Ценности: что важно в культуре',
          'Нормы: правила поведения',
          'Традиции: передача из поколения в поколение',
          'Обряды: ритуальные действия',
          'Ритуалы: символические практики',
          'Практика: анализ ценностей и норм',
          'Современные ценности и традиции',
        ],
      };
    }

    // Культурные коды
    if (lowerTopicName.includes('культурные коды') || lowerTopicName.includes('символы и знаки') || lowerTopicName.includes('семиотика')) {
      return {
        count: 7,
        names: [
          'Культурные коды: скрытые смыслы',
          'Символы: знаки с особым значением',
          'Знаки: обозначение и значение',
          'Семиотика культуры: наука о знаках',
          'Декодирование: понимание культурных кодов',
          'Практика: анализ символов в культуре',
          'Современные культурные коды',
        ],
      };
    }

    // Язык и текст
    if (lowerTopicName.includes('язык, текст и дискурс')) {
      return {
        count: 6,
        names: [
          'Язык как носитель культуры',
          'Текст: культурное сообщение',
          'Дискурс: способ говорения о мире',
          'Интерпретация текстов',
          'Практика: анализ культурных текстов',
          'Современные формы текста: цифровые медиа',
        ],
      };
    }

    // Типология культур
    if (lowerTopicName.includes('типология культур') || lowerTopicName.includes('народная, элитарная, массовая')) {
      return {
        count: 7,
        names: [
          'Народная культура: традиции народа',
          'Элитарная культура: культура элиты',
          'Массовая культура: культура для всех',
          'Субкультуры: культуры внутри культуры',
          'Контркультуры: альтернативные культуры',
          'Практика: анализ типов культуры',
          'Современная типология культур',
        ],
      };
    }

    // Исторические типы культуры
    if (lowerTopicName.includes('исторические типы') || lowerTopicName.includes('традиционная, индустриальная') || lowerTopicName.includes('модерн и постмодерн')) {
      return {
        count: 8,
        names: [
          'Традиционная культура: доиндустриальная эпоха',
          'Индустриальная культура: эпоха машин',
          'Постиндустриальная культура: информационное общество',
          'Модерн: культура модернизации',
          'Постмодерн: критика модерна',
          'Сравнение типов культуры',
          'Практика: анализ исторического типа культуры',
          'Современная культура: какой тип?',
        ],
      };
    }

    // Национальные модели
    if (lowerTopicName.includes('национальные и цивилизационные модели')) {
      return {
        count: 7,
        names: [
          'Национальная культура: особенности нации',
          'Цивилизационные модели: западная, восточная',
          'Русская цивилизация: особенности',
          'Диалог цивилизаций',
          'Практика: сравнение культурных моделей',
          'Глобализация и национальная культура',
          'Современные цивилизационные процессы',
        ],
      };
    }

    // Культура России
    if (lowerTopicName.includes('культура россии') || lowerTopicName.includes('цивилизационные особенности')) {
      return {
        count: 8,
        names: [
          'Особенности русской культуры',
          'Исторические этапы: от Древней Руси до наших дней',
          'Православие и русская культура',
          'Запад и Восток в русской культуре',
          'Русская литература и искусство',
          'Современная русская культура',
          'Практика: анализ русской культуры',
          'Русская культура в глобальном контексте',
        ],
      };
    }

    // Религия и миф
    if (lowerTopicName.includes('религия и миф') || lowerTopicName.includes('структуре культуры')) {
      return {
        count: 6,
        names: [
          'Миф: древняя форма культуры',
          'Религия: сакральное в культуре',
          'Миф и религия: сходство и различия',
          'Роль религии в культуре',
          'Практика: анализ мифов и религиозных текстов',
          'Светская культура и религия',
        ],
      };
    }

    // Художественная культура
    if (lowerTopicName.includes('художественная культура') || lowerTopicName.includes('эстетическое сознание')) {
      return {
        count: 6,
        names: [
          'Художественная культура: искусство в культуре',
          'Эстетическое сознание: восприятие красоты',
          'Функции искусства в культуре',
          'Искусство и реальность',
          'Практика: анализ художественных произведений',
          'Современное искусство и культура',
        ],
      };
    }

    // Нравственная, правовая, политическая культура
    if (lowerTopicName.includes('нравственная, правовая и политическая культура')) {
      return {
        count: 7,
        names: [
          'Нравственная культура: мораль и этика',
          'Правовая культура: закон и право',
          'Политическая культура: власть и общество',
          'Взаимосвязь видов культуры',
          'Практика: анализ культурных норм',
          'Современные вызовы: кризис ценностей?',
          'Культура и демократия',
        ],
      };
    }

    // Городская культура
    if (lowerTopicName.includes('городская и повседневная культура')) {
      return {
        count: 6,
        names: [
          'Городская культура: жизнь в городе',
          'Повседневная культура: обыденная жизнь',
          'Город и деревня: различия культур',
          'Урбанизация и культура',
          'Практика: анализ городской культуры',
          'Современная городская культура',
        ],
      };
    }

    // Массовая культура
    if (lowerTopicName.includes('массовая культура') || lowerTopicName.includes('медиа и культурные индустрии')) {
      return {
        count: 7,
        names: [
          'Массовая культура: культура для всех',
          'Медиа: средства массовой информации',
          'Культурные индустрии: производство культуры',
          'Критика массовой культуры',
          'Массовая и элитарная культура',
          'Практика: анализ массовой культуры',
          'Цифровая массовая культура',
        ],
      };
    }

    // Цифровая культура
    if (lowerTopicName.includes('цифровая культура') || lowerTopicName.includes('сетевые сообщества')) {
      return {
        count: 6,
        names: [
          'Цифровая культура: культура интернета',
          'Сетевые сообщества: виртуальные группы',
          'Особенности цифровой коммуникации',
          'Цифровая идентичность',
          'Практика: анализ цифровой культуры',
          'Будущее цифровой культуры',
        ],
      };
    }

    // Культурная память
    if (lowerTopicName.includes('культурная память') || lowerTopicName.includes('культурное наследие')) {
      return {
        count: 6,
        names: [
          'Культурная память: что помнит культура',
          'Культурное наследие: наследие прошлого',
          'Сохранение культурного наследия',
          'Память и забвение в культуре',
          'Практика: анализ культурного наследия',
          'Современные проблемы сохранения наследия',
        ],
      };
    }

    // Культурная политика
    if (lowerTopicName.includes('культурная политика') || lowerTopicName.includes('управление культурой')) {
      return {
        count: 6,
        names: [
          'Культурная политика: управление культурой',
          'Государство и культура',
          'Институты культуры: музеи, театры, библиотеки',
          'Финансирование культуры',
          'Практика: анализ культурной политики',
          'Современные вызовы культурной политики',
        ],
      };
    }

    // Межкультурная коммуникация
    if (lowerTopicName.includes('межкультурная коммуникация') || lowerTopicName.includes('диалог культур')) {
      return {
        count: 6,
        names: [
          'Межкультурная коммуникация: общение между культурами',
          'Барьеры в межкультурном общении',
          'Диалог культур: взаимопонимание',
          'Культурный шок и адаптация',
          'Практика: анализ межкультурного взаимодействия',
          'Глобализация и межкультурная коммуникация',
        ],
      };
    }

    // Глобализация
    if (lowerTopicName.includes('глобализация и локализация') || lowerTopicName.includes('глокализация')) {
      return {
        count: 6,
        names: [
          'Глобализация: единое культурное пространство',
          'Локализация: сохранение местной культуры',
          'Глокализация: глобальное и локальное',
          'Культурный империализм',
          'Практика: анализ процессов глобализации',
          'Будущее культуры в глобальном мире',
        ],
      };
    }

    // Культура и технологии
    if (lowerTopicName.includes('культура и технологии') || lowerTopicName.includes('техногенная цивилизация') || lowerTopicName.includes('биотехнологии, ии')) {
      return {
        count: 7,
        names: [
          'Техногенная цивилизация: культура и техника',
          'Биотехнологии: культура и биология',
          'Искусственный интеллект: культура и машины',
          'Цифровая культура: новые формы',
          'Этика технологий',
          'Практика: анализ влияния технологий на культуру',
          'Будущее: культура в эпоху ИИ',
        ],
      };
    }

    // Культура и власть
    if (lowerTopicName.includes('культура, идентичность и власть') || lowerTopicName.includes('идеология, гегемония')) {
      return {
        count: 7,
        names: [
          'Идеология: культура и власть',
          'Гегемония: доминирование в культуре',
          'Культурный капитал: ресурсы культуры',
          'Власть и сопротивление в культуре',
          'Практика: анализ отношений культуры и власти',
          'Современные формы культурной власти',
          'Культура и демократия',
        ],
      };
    }

    // Глобальные вызовы
    if (lowerTopicName.includes('глобальные вызовы') || lowerTopicName.includes('сценарии развития культуры')) {
      return {
        count: 6,
        names: [
          'Глобальные вызовы: что угрожает культуре',
          'Экологический кризис и культура',
          'Цифровизация: возможности и риски',
          'Сценарии будущего культуры',
          'Практика: прогнозирование развития культуры',
          'Культура в эпоху неопределённости',
        ],
      };
    }

    // По умолчанию для остальных тем (5 уроков)
    return {
      count: 5,
      names: [
        `Введение в тему: ${topicName.length > 40 ? topicName.substring(0, 37) + '...' : topicName}`,
        'Основные понятия и определения',
        'Правила и закономерности',
        'Практические примеры и упражнения',
        'Итоговое закрепление материала',
      ],
    };
  }

  public async up(queryRunner: QueryRunner): Promise<void> {
    console.log('💻 Начинаю добавление уроков для дисциплин "Информатика и ИКТ" и "Культурология"...');

    // Проверяем существование таблицы lessons
    const tableExists = await queryRunner.query(`
      SELECT 1 FROM information_schema.tables 
      WHERE table_schema = 'public' AND table_name = 'lessons'
    `);

    if (!(Array.isArray(tableExists) && tableExists.length > 0)) {
      throw new Error('Table lessons does not exist');
    }

    // Проверяем существование колонок
    const isVerifiedExists = await queryRunner.query(`
      SELECT 1 FROM information_schema.columns 
      WHERE table_schema = 'public' 
      AND table_name = 'lessons' 
      AND column_name = 'IsVerified'
    `);

    if (!(Array.isArray(isVerifiedExists) && isVerifiedExists.length > 0)) {
      throw new Error('Column IsVerified does not exist. Please run migration 1763600000000-AddFieldsToLessons first.');
    }

    // Получаем максимальный ID уроков
    const maxIdResult = await queryRunner.query(`
      SELECT COALESCE(MAX("ID"), 0) as max_id FROM "lessons"
    `);
    const maxLessonId = parseInt(maxIdResult[0]?.max_id || '0', 10);
    let nextLessonId = maxLessonId + 1;

    // Получаем все темы для дисциплин
    const disciplines = [
      'c0e9a8b7-3d6f-4a02-9e5c-7f6a8b9c0d1e', // Информатика и ИКТ
      'e7f6a5b4-0c3e-5139-2a4e-4b5c6d7e8f9a', // Культурология
    ];

    // Используем простой запрос без параметров для TypeORM
    const disciplinesStr = disciplines.map(d => `'${d}'`).join(', ');
    const topicsResult = await queryRunner.query(`
      SELECT "TopicID", "TopicName", "DisciplineID"
      FROM "topics"
      WHERE "DisciplineID" IN (${disciplinesStr})
      ORDER BY "DisciplineID", "ID"
    `);

    if (!Array.isArray(topicsResult) || topicsResult.length === 0) {
      console.log('⚠️  Темы для дисциплин не найдены');
      return;
    }

    console.log(`📝 Найдено ${topicsResult.length} тем для обработки`);

    // Проверяем, есть ли уже уроки для этих тем
    const topicIds = topicsResult.map(t => t.TopicID);
    if (topicIds.length === 0) {
      console.log('⚠️  Темы не найдены');
      return;
    }
    
    const topicIdsStr = topicIds.map(id => `'${id}'`).join(', ');
    const existingLessons = await queryRunner.query(`
      SELECT COUNT(*) as count FROM "lessons"
      WHERE "TopicID" IN (${topicIdsStr})
    `);

    const existingCount = parseInt(existingLessons[0]?.count || '0', 10);
    if (existingCount > 0) {
      console.log(`⚠️  Для некоторых тем уже существуют ${existingCount} уроков. Пропускаем создание дубликатов (используется ON CONFLICT DO NOTHING).`);
      // Продолжаем выполнение - ON CONFLICT DO NOTHING пропустит существующие уроки
    }

    // Генерируем уроки для каждой темы
    const allLessons: Array<{
      LessonID: string;
      ID: number;
      LessonName: string;
      TopicID: string;
      IsVerified: boolean;
      Order: number;
      Description: string | null;
      CreatedAt: Date;
      UpdatedAt: Date;
    }> = [];

    for (const topic of topicsResult) {
      const lessonPlan = this.getLessonPlanForTopic(topic.TopicName);
      const lessons = this.generateLessonsForTopic(
        topic.TopicID,
        topic.TopicName,
        lessonPlan.count,
        lessonPlan.names,
        nextLessonId,
      );
      allLessons.push(...lessons);
      nextLessonId += lessonPlan.count;
    }

    console.log(`📚 Создано ${allLessons.length} уроков для ${topicsResult.length} тем`);

    // Вставляем уроки батчами по 50 для эффективности
    const batchSize = 50;
    for (let i = 0; i < allLessons.length; i += batchSize) {
      const batch = allLessons.slice(i, i + batchSize);
      
      // Создаем значения для INSERT, используя детерминированный UUID
      const values = batch
        .map(
          (lesson, idx) => {
            // Генерируем детерминированный UUID на основе TopicID и ID урока
            const seed = `${lesson.TopicID}-${lesson.ID}`;
            let hash1 = 0, hash2 = 0, hash3 = 0, hash4 = 0;
            for (let i = 0; i < seed.length; i++) {
              const char = seed.charCodeAt(i);
              hash1 = ((hash1 << 5) - hash1) + char;
              hash2 = ((hash2 << 7) - hash2) + char + i;
              hash3 = ((hash3 << 3) - hash3) + char * 3;
              hash4 = ((hash4 << 11) - hash4) + char * 7;
            }
            // Генерируем части UUID (8-4-4-4-12 символов)
            const h1 = Math.abs(hash1).toString(16).padStart(8, '0').substring(0, 8);
            const h2 = Math.abs(hash2).toString(16).padStart(4, '0').substring(0, 4);
            const h3 = Math.abs(hash3).toString(16).padStart(3, '0').substring(0, 3);
            const h4 = (Math.abs(hash1 + hash2) % 4); // 0-3 для выбора 8,9,a,b
            const variant = ['8', '9', 'a', 'b'][h4];
            const h5 = Math.abs(hash3 + hash4).toString(16).padStart(3, '0').substring(0, 3);
            const h6 = Math.abs(hash1 * hash2).toString(16).padStart(12, '0').substring(0, 12);
            const lessonId = `${h1}-${h2}-4${h3}-${variant}${h5}-${h6}`;
            
            return `(
              '${lessonId}',
              ${lesson.ID},
              ${this.escapeString(lesson.LessonName)},
              '${lesson.TopicID}'::uuid,
              ${lesson.IsVerified},
              ${lesson.Order !== null ? lesson.Order : 'NULL'},
              ${lesson.Description ? this.escapeString(lesson.Description) : 'NULL'},
              '${lesson.CreatedAt.toISOString()}'::timestamp,
              '${lesson.UpdatedAt.toISOString()}'::timestamp
            )`;
          }
        )
        .join(',');

      await queryRunner.query(`
        INSERT INTO "lessons" (
          "LessonID", "ID", "LessonName", "TopicID", 
          "IsVerified", "Order", "Description", 
          "CreatedAt", "UpdatedAt"
        )
        VALUES ${values}
        ON CONFLICT ("LessonID") DO NOTHING
      `);
    }

    console.log('✅ Уроки успешно добавлены!');
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    console.log('🔄 Откатываю добавление уроков...');

    // Удаляем уроки для тем дисциплин
    const disciplines = [
      'c0e9a8b7-3d6f-4a02-9e5c-7f6a8b9c0d1e', // Информатика и ИКТ
      'e7f6a5b4-0c3e-5139-2a4e-4b5c6d7e8f9a', // Культурология
    ];

    const disciplinesStr = disciplines.map(d => `'${d}'`).join(', ');
    await queryRunner.query(`
      DELETE FROM "lessons"
      WHERE "TopicID" IN (
        SELECT "TopicID" FROM "topics"
        WHERE "DisciplineID" IN (${disciplinesStr})
      )
    `);

    console.log('✅ Откат завершен');
  }
}

