# Multi-stage build –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞
FROM node:20-alpine AS builder

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã package.json –∏ package-lock.json
COPY package*.json ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN npm ci

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
RUN npm run build

# –í–ê–ñ–ù–û: –ö–æ–ø–∏—Ä—É–µ–º SQL —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ dist/migrations/ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏
RUN mkdir -p dist/migrations && \
    if [ -f src/migrations/topics-insert.sql ]; then \
      cp src/migrations/topics-insert.sql dist/migrations/topics-insert.sql && \
      echo "‚úÖ –§–∞–π–ª topics-insert.sql —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ dist/migrations/"; \
    else \
      echo "‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª src/migrations/topics-insert.sql –Ω–µ –Ω–∞–π–¥–µ–Ω!" && \
      exit 1; \
    fi

# –ö–æ–ø–∏—Ä—É–µ–º production –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –≤ dist/config/
RUN mkdir -p dist/config && \
    cp src/config/typeorm.config.prod.js dist/config/typeorm.config.prod.js && \
    echo "‚úÖ Production –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ dist/config/"

# Production stage
FROM node:20-alpine AS production

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º package.json –∏ package-lock.json
COPY package*.json ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN npm ci --only=production

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ builder stage (–≤–∫–ª—é—á–∞—è SQL —Ñ–∞–π–ª –∏ production –∫–æ–Ω—Ñ–∏–≥)
COPY --from=builder /app/dist ./dist

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ production –∫–æ–Ω—Ñ–∏–≥ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Å—Ç–µ
RUN echo "üì¶ Checking migration files..." && \
    ls -la dist/config/typeorm.config.prod.js && \
    ls -la dist/migrations/*.js | head -5 && \
    echo "‚úÖ Migration files are ready"

# –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ (start.sh –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
COPY start.sh /app/start.sh

# –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ Node.js (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
COPY scripts/run-migrations.js /app/scripts/run-migrations.js
RUN chmod +x /app/scripts/run-migrations.js

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nestjs -u 1001

# –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤ –∏ –ø—Ä–∞–≤–∞
RUN chown -R nestjs:nodejs /app
RUN chmod +x /app/start.sh
USER nestjs

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 3000

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ start.sh
# start.sh –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (npm run migration:run:prod) –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
CMD ["/app/start.sh"]
