# –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üö® –í–∞–∂–Ω–æ –¥–ª—è Production

–í production –æ–∫—Ä—É–∂–µ–Ω–∏–∏ **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** `synchronize: true`! –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö.

## üìã –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å—É—â–Ω–æ—Å—Ç—è—Ö
npm run migration:create

# –†—É—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏–º–µ–Ω–∏
npm run migration:generate src/migrations/AddNewField
```

### –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
npm run migration:run

# –û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
npm run migration:revert
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

### 1. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
1. –í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ entity —Ñ–∞–π–ª—ã
2. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é: `npm run migration:create`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SQL –∫–æ–¥
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ: `npm run migration:run`
5. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –≤ git

### 2. Production –¥–µ–ø–ª–æ–π
1. –ü—Ä–∏ –¥–µ–ø–ª–æ–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–∫–∞—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é: `npm run migration:revert`

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π

```
src/migrations/
‚îú‚îÄ‚îÄ 1700000000000-InitialMigration.ts    # –ü–µ—Ä–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ 1700000001000-AddNewField.ts         # –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ ...
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π

### –í database.config.ts
```typescript
export const getDatabaseConfig = (configService: ConfigService): TypeOrmModuleOptions => ({
  // ... –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  migrations: [__dirname + '/../migrations/*{.ts,.js}'],
  migrationsRun: configService.get('NODE_ENV') === 'production', // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≤ production
  synchronize: configService.get('NODE_ENV') !== 'production', // –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
});
```

### –í Dockerfile.prod
```dockerfile
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
CMD ["/app/start.sh"]
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ SQL –∫–æ–¥ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
- –î–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏

### 2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ë–æ–ª—å—à–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–∞–∑–±–∏–≤–∞–π—Ç–µ –±–æ–ª—å—à–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ

### 3. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏
- –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞ "Migration already exists"
```bash
# –£–¥–∞–ª–∏—Ç–µ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏
rm src/migrations/duplicate-migration.ts
```

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo $DB_HOST $DB_PORT $DB_USERNAME $DB_NAME
```

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
# –û—Ç–∫–∞—Ç–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
npm run migration:revert

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
npm run typeorm migration:show
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–∏–≥—Ä–∞—Ü–∏–π

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å
npm run typeorm migration:show
```

### –õ–æ–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –í production –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
docker logs your-app-container
```

## üîÑ –ü—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
```typescript
export class AddUserPhone1700000001000 implements MigrationInterface {
    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`ALTER TABLE "user" ADD "phone" character varying`);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`ALTER TABLE "user" DROP COLUMN "phone"`);
    }
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
```typescript
export class AddUserEmailIndex1700000002000 implements MigrationInterface {
    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`CREATE INDEX "IDX_user_email" ON "user" ("email")`);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`DROP INDEX "IDX_user_email"`);
    }
}
```
